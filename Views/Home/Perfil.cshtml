@{
    ViewData["Title"] = "Perfil";
}

<link rel="stylesheet" href="~/css/perfil.css" asp-append-version="true" />

<div class="profile-card">
    <div class="profile-header">
        <div class="profile-picture-container">
            <img src="@ViewBag.usuario.fotoPerfil" alt="Foto de perfil" class="profile-picture" />
        </div>
        
        <a href='@Url.Action("Configuracion", "Home")' class="edit-profile-btn">Editar Perfil</a>
    </div>

    <div class="profile-info">
        <div class="info-group">
            <label class="info-label">Nombre de usuario:</label>
            <p class="info-value">@ViewBag.usuario.nombreUsuario</p>
        </div>

        <div class="info-group description-group">
            <label class="info-label">Descripción:</label>
            <p class="info-value">@ViewBag.usuario.descripcion</p>
        </div>

        @if (ViewBag.usuario.tipoUsuario == "responsable" && ViewBag.Vinculos.Count > 0)
        {
            <div class="info-group">
                <label class="info-label">Perteneciente/s:</label>
                <p class="info-value">@ViewBag.Vinculos[0].nombre @ViewBag.Vinculos[0].apellido</p>
            </div>
        }
        else if (ViewBag.usuario.tipoUsuario == "perteneciente" && ViewBag.Vinculos.Count > 0)
        {
            <div class="info-group">
                <label class="info-label">Tutor/es:</label>
                <p class="info-value">@ViewBag.Vinculos[0].nombre @ViewBag.Vinculos[0].apellido</p>
            </div>
        }

        @if(ViewBag.TocoMasPefil)
        {
            <div class="info-group">
                <label class="info-label">Nombre:</label>
                <p class="info-value">@ViewBag.usuario.nombre</p>
            </div>
            <div class="info-group">
                <label class="info-label">Apellido:</label>
                <p class="info-value">@ViewBag.usuario.apellido</p>
            </div>
            <div class="info-group">
                <label class="info-label">Email:</label>
                <p class="info-value">@ViewBag.usuario.mail</p>
            </div>
            <div class="info-group">
                <label class="info-label">Fecha de Nacimiento:</label>
                <p class="info-value">@ViewBag.usuario.fechaNacimiento?.ToString("dd/MM/yyyy")</p>
            </div>
            <div class="info-group">
                <label class="info-label">Teléfono:</label>
                <p class="info-value">@ViewBag.usuario.telefono</p>
            </div>
            <div class="info-group">
                <label class="info-label">Nivel de Apoyo:</label>
                <p class="info-value">@ViewBag.usuario.nivelApoyo</p>
            </div>
            <div class="info-group">
                <label class="info-label">Puntos:</label>
                <p class="info-value">@ViewBag.usuario.puntos</p>
            </div>
        
        }
        
        @if (ViewBag.usuario.tipoUsuario == "responsable") //poner todo esto tmb en una view de mis pertenecientes post jueves asi no surgen mas errores 
        {
            <section class="Perfil_Relaciones">
                <h3>Mis Pertenecientes Vinculados</h3>

                @foreach (Usuario perteneciente in ViewBag.Vinculos)
                {
                    <div class="vinculo-card">
                        <p><strong>Nombre:</strong> @perteneciente.nombre @perteneciente.apellido </p>
                        <p><strong>Email:</strong> @perteneciente.mail</p>
                        <p><strong>Teléfono:</strong> @perteneciente.telefono</p>
                        
                        <form method="post" asp-action="EliminarVinculo" style="display:inline;">
                            <input type="hidden" name="idTutor" value="@ViewBag.usuario.id" />
                            <input type="hidden" name="idPerteneciente" value="@perteneciente.id" />
                            <button type="submit" class="btn btn-danger btn-sm">Eliminar vínculo</button>
                        </form>
                    </div>
                }
                
                <hr class="seccion-divisor" />
                
                <h4>Agregar Nuevo Perteneciente</h4>
                <form method="post" asp-action="AgregarVinculo" class="vinculo-form">
                    
                    <div>
                        <label for="buscadorPerteneciente">Buscar usuario:</label>
                        <input type="text" id="buscadorPerteneciente" class="form-control" placeholder="Escribe un nombre o usuario..." autocomplete="off">
                        
                        <div id="listaResultados" class="search-results"></div>
                    </div>

                    <input type="hidden" id="selectedPertenecienteId" name="idPerteneciente" value="">
                    <div>
                        <label for="parentesco">Parentesco:</label>
                        <input type="text" name="parentesco" required />
                    </div>

                    <input type="hidden" name="idTutor" value="@ViewBag.usuario.id" />
                    <button type="submit" class="btn btn-primary mt-2">Agregar vínculo</button>
                </form>
            </section>
        }
        
        <a href='@Url.Action(ViewBag.TocoMasPefil ? "Perfil" : "VerMasPerfil", "Home")' class="nav-link" >
            @(ViewBag.TocoMasPefil ? "Ver menos datos" : "Ver más datos")
        </a>
    </div>

    <div class="bubble bubble-tl"></div>
    <div class="bubble bubble-tr"></div>
    <div class="bubble bubble-bl"></div>
    <div class="bubble bubble-br"></div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. OBTENER DATOS (Corregido)
            // Leemos la lista de C# (ViewBag) y la convertimos a un array de JavaScript
            const usuariosDisponibles = @Html.Raw(Json.Serialize(ViewBag.UsuariosDisponibles ?? new List<Usuario>()));

            // 2. OBTENER ELEMENTOS DOM (Corregido)
            // Usamos los IDs de TU HTML
            const input = document.getElementById('buscadorPerteneciente');
            const lista = document.getElementById('listaResultados');
            const hiddenInput = document.getElementById('selectedPertenecienteId');

            // Si el input no existe (porque el usuario no es 'responsable'), detenemos el script
            if (!input) return; 

            // 3. RENDERIZAR (Corregido)
            function renderList(items) {
                lista.innerHTML = ''; 
                
                if (input.value === '') { // Oculta si el input está vacío
                    lista.style.display = 'none';
                    return;
                }
                lista.style.display = 'block'; 
                
                items.forEach(usuario => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    // Usamos las propiedades de TU 'Usuario.cs'
                    div.innerHTML = `<strong>${usuario.nombre ?? ''} ${usuario.apellido ?? ''}</strong> (${usuario.nombreUsuario})`;
                    
                    div.dataset.id = usuario.id;
                    div.dataset.name = `${usuario.nombre ?? ''} ${usuario.apellido ?? ''} (${usuario.nombreUsuario})`;

                    // 4. LÓGICA DE CLIC (Corregido)
                    div.addEventListener('click', () => {
                        // Ponemos el ID en el input oculto (name="idPerteneciente")
                        hiddenInput.value = div.dataset.id;
                        
                        // Mostramos la selección en el input
                        input.value = div.dataset.name;
                        
                        // Ocultamos la lista
                        lista.innerHTML = '';
                        lista.style.display = 'none';
                    });
                    
                    lista.appendChild(div);
                });
            }

            // 5. FILTRAR (Corregido)
            input.addEventListener('input', () => {
                const texto = input.value.trim().toLowerCase();
                
                hiddenInput.value = ""; // Resetea el ID si el usuario escribe de nuevo

                if (texto === '') {
                    renderList([]);
                } else {
                    // Filtramos por las propiedades de TU 'Usuario.cs'
                    const filtrados = usuariosDisponibles.filter(u => 
                        (u.nombre && u.nombre.toLowerCase().includes(texto)) ||
                        (u.apellido && u.apellido.toLowerCase().includes(texto)) ||
                        u.nombreUsuario.toLowerCase().includes(texto)
                    );
                    renderList(filtrados);
                }
            });

            // Evitar que "Enter" en el buscador envíe el formulario
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
        });
    </script>
}